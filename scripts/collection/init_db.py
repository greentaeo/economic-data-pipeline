import os
import sys
from sqlalchemy import create_engine, text
from dotenv import load_dotenv

sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '../../')))
load_dotenv()

DB_URI = os.getenv("SUPABASE_DB_URI")


def init_database():
    print(f"ğŸš€ ìƒˆ Supabase DB ì´ˆê¸°í™” ì¤‘... ({DB_URI.split('@')[-1]})")

    engine = create_engine(DB_URI)

    # ì£¼ì‹ ë°ì´í„° ì „ìš© í…Œì´ë¸” ìƒì„± SQL
    create_table_sql = """
    CREATE TABLE IF NOT EXISTS market_price_daily (
        id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        trade_date TIMESTAMP WITHOUT TIME ZONE NOT NULL,
        symbol VARCHAR(10) NOT NULL,
        open_price NUMERIC,
        high_price NUMERIC,
        low_price NUMERIC,
        close_price NUMERIC,
        volume BIGINT,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
    );

    -- ì¤‘ë³µ ë°©ì§€ìš© ì¸ë±ìŠ¤ (ê°™ì€ ë‚ ì§œ, ê°™ì€ ì¢…ëª©ì€ 1ê°œë§Œ)
    CREATE UNIQUE INDEX IF NOT EXISTS idx_symbol_date 
    ON market_price_daily (symbol, trade_date);

    -- ìœ ë‹ˆí¬ ì œì•½ì¡°ê±´ ì¶”ê°€ (Upsertìš©)
    ALTER TABLE market_price_daily 
    DROP CONSTRAINT IF EXISTS unique_symbol_date;

    ALTER TABLE market_price_daily 
    ADD CONSTRAINT unique_symbol_date UNIQUE (symbol, trade_date);
    """

    try:
        with engine.begin() as conn:
            conn.execute(text(create_table_sql))
        print("âœ… í…Œì´ë¸” ìƒì„± ì™„ë£Œ! (market_price_daily)")
        print("ğŸ‰ ì´ì œ ì£¼ì‹ ë°ì´í„°ë¥¼ ë°›ì„ ì¤€ë¹„ê°€ ëë‚¬ìŠµë‹ˆë‹¤.")

    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}")


if __name__ == "__main__":
    init_database()